<!doctype html>
<html lang="kk">
<head>
  <meta charset="utf-8">
  <title>Жергілікті аймақтағы эпидемия/вирус ошақтары — EpidemicSim</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body { font-family: "Inter", sans-serif; padding-top: 90px; background: linear-gradient(135deg,#eef7ff,#f7fbff); }
    .big-title{ font-weight:800; background:linear-gradient(45deg,#0ea5e9,#6366f1); -webkit-background-clip:text; color:transparent; font-size:28px }
     .globe-container{ height:520px; border-radius:10px; overflow:hidden; position:relative }
     /* Leaflet map size */
     #kzMap{ height:520px; border-radius:10px; }
    /* Left panel item styling */
    .local-item { background: white; border-radius: 12px; box-shadow: 0 8px 20px rgba(2,6,23,0.04); }
    .local-item .virus-avatar{ width:48px; height:48px; border-radius:12px; font-size:14px; }
    .local-item .badge { font-size: 12px; }
    .target-item { background: transparent; padding: 10px 12px; border-radius: 8px; margin-bottom:8px; }
    .target-item.list-group-item { background: #ffffff; }
    .target-item:hover, .local-item:hover { transform: translateY(-3px); transition: all .12s ease; }
    .fw-medium{ font-weight:600; }
  </style>
</head>
<body>

  {% include 'navbar.html' %}

  <div class="container py-5">
    <div class="row">
      <div class="col-12">
        <div class="card p-4 shadow-sm">
          <h2 class="big-title">Жергілікті аймақтағы эпидемия/вирус ошақтары</h2>
          <p class="text-muted">Бұл бетте сіз жергілікті аймақта тіркелген эпидемия/вирус ошақтарының қысқаша тізімін және олардың орналасқан жерін көресіз. Тізімдегі элементтерге басқанда глобус сол орынға ұшады.</p>
        </div>
      </div>
    </div>

    <div class="row g-4 mt-3">
      <div class="col-lg-4">
        <div class="card p-3">
          <div class="d-flex align-items-center justify-content-between mb-3">
            <div>
              <h5 class="mb-0">Жергілікті ошақтар</h5>
              <div class="small text-muted">Облыстар бойынша шыққан ошақтар мен олардың таралу аймақтары</div>
            </div>
            <div class="text-end">
              {% set totals = namespace(count=0, cases=0) %}
              {% for o in local_outbreaks %}
                {% set totals.count = totals.count + 1 %}
                {% set totals.cases = totals.cases + o.cases %}
              {% endfor %}
              <div class="small text-muted">Ошақтар: <strong>{{ totals.count }}</strong></div>
              <div class="small text-muted">Жалпы жұққандар: <strong>{{ totals.cases }}</strong></div>
            </div>
          </div>

          <div class="mb-2">
            <input id="localSearch" class="form-control form-control-sm" placeholder="Іздеу: облыс немесе ауру (мыс: Almaty, COVID)" />
          </div>

          <div id="localList" style="max-height:440px; overflow:auto;">
            {% for o in local_outbreaks %}
                {% set outer_idx = loop.index0 %}
                <div class="list-group-item local-item p-3 mb-2" data-index="{{ outer_idx }}" data-lat="{{ o.lat }}" data-lng="{{ o.lng }}" data-name="{{ o.region }} {{ o.disease }}">
                  <div class="d-flex align-items-start">
                      <div class="me-3">
                      <div class="virus-avatar">{{ o.region[:2]|upper }}</div>
                    </div>
                    <div class="flex-fill">
                      <div class="d-flex align-items-baseline justify-content-between">
                        <div>
                          <div class="fw-semibold">{{ o.region }}</div>
                          <div class="small text-muted">{{ o.disease }}</div>
                        </div>
                        <div class="text-end">
                          <div><span class="badge bg-danger">{{ o.cases }} адам</span></div>
                        </div>
                      </div>
                      <div class="mt-2">
                        <div class="d-flex gap-2">
                          <button type="button" class="btn btn-sm btn-outline-primary btn-fly">Көрсету</button>
                          <button type="button" class="btn btn-sm btn-outline-secondary btn-highlight">Нақты көрсету</button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                {% for t in o.spread_to %}
                  <div class="ps-4 pe-2 py-2 border-start target-item list-group-item" data-origin-index="{{ outer_idx }}" data-target-index="{{ loop.index0 }}" data-lat="{{ t.lat }}" data-lng="{{ t.lng }}" data-name="{{ t.region }} {{ t.disease }}">
                    <div class="d-flex align-items-center justify-content-between">
                      <div>
                        <div class="fw-medium">{{ t.region }}</div>
                        <div class="small text-muted">{{ t.disease }} — жұққандар: {{ t.cases }} адам</div>
                      </div>
                      <div>
                        <button type="button" class="btn btn-sm btn-outline-info btn-show-target">Көрсету</button>
                      </div>
                    </div>
                  </div>
                {% endfor %}
            {% endfor %}
          </div>
        </div>
      </div>

      <div class="col-lg-8">
        <div class="card p-3 globe-view">
             <h5 class="mb-3">Қазақстан картасы — облыстар бойынша ошақтар</h5>
             <div id="kzMap" class="globe-container"></div>
        </div>
      </div>
    </div>
  </div>

      <!-- JSON payload for JS (local outbreaks for Kazakhstan) -->
      <script id="kzOutbreaksData" type="application/json">{{ local_outbreaks|tojson|safe }}</script>

      <!-- Leaflet -->
      <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="" crossorigin=""/>
      <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

      <script>
      document.addEventListener('DOMContentLoaded', function(){
        const dataEl = document.getElementById('kzOutbreaksData');
        let outbreaks = [];
        try{ outbreaks = dataEl ? JSON.parse(dataEl.textContent || '[]') : []; }catch(e){ outbreaks = []; }

        // init Leaflet map centered on Kazakhstan
        const map = L.map('kzMap', { zoomControl:true }).setView([48.0, 66.0], 4);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 18,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const allLatLngs = [];
        const originLayers = []; // store markers and lines per origin

        outbreaks.forEach((origin, idx) => {
          const oLatLng = [origin.lat, origin.lng];
          allLatLngs.push(oLatLng);

          // origin marker (bigger)
          const originMarker = L.circleMarker(oLatLng, {
            radius: Math.min(20, 6 + Math.sqrt(origin.cases)),
            color: '#a11',
            fillColor: '#ff3b30',
            fillOpacity: 0.9,
            weight: 1
          }).addTo(map).bindPopup(`<strong>${origin.region}</strong><br>Disease: ${origin.disease || '—'}<br>Cases: ${origin.cases}`);

          const targetMarkers = [];
          const lines = [];

          (origin.spread_to || []).forEach(t => {
            const tLatLng = [t.lat, t.lng];
            allLatLngs.push(tLatLng);

            const targetMarker = L.circleMarker(tLatLng, {
              radius: Math.min(12, 4 + Math.sqrt(t.cases || 1)),
              color: '#d9534f',
              fillColor: '#f77',
              fillOpacity: 0.8,
              weight: 1
            }).addTo(map).bindPopup(`<strong>${t.region}</strong><br>Disease: ${t.disease || '—'}<br>Cases: ${t.cases}`);

            const line = L.polyline([oLatLng, tLatLng], { color: '#ff6b6b', weight: 2, dashArray: '6 6' }).addTo(map);

            targetMarkers.push(targetMarker);
            lines.push(line);
          });

          originLayers[idx] = {
            originMarker: originMarker,
            targets: targetMarkers,
            lines: lines,
            data: origin
          };
        });

        if(allLatLngs.length) map.fitBounds(allLatLngs, { padding: [40,40] });

        // helper to reset styles
        function resetStyles(){
          originLayers.forEach(item => {
            try{ item.originMarker.setStyle({ radius: Math.min(20, 6 + Math.sqrt(item.data.cases)), color: '#a11', fillColor: '#ff3b30', fillOpacity:0.9, weight:1 }); }catch(e){}
            (item.targets || []).forEach(m => { try{ m.setStyle({ radius: Math.min(12, 4 + Math.sqrt(1)), color:'#d9534f', fillColor:'#f77', fillOpacity:0.8, weight:1 }); }catch(e){} });
            (item.lines || []).forEach(l => { try{ l.setStyle({ color:'#ff6b6b', weight:2, dashArray:'6 6', opacity:0.8 }); }catch(e){} });
          });
        }

        // highlight a specific origin and its spread
        function highlightOrigin(idx){
          resetStyles();
          const item = originLayers[idx];
          if(!item) return;
          try{ item.originMarker.setStyle({ radius: Math.min(26, 10 + Math.sqrt(item.data.cases)), color: '#550000', fillColor: '#ff1f1f', fillOpacity:1, weight:2 }); }catch(e){}
          (item.targets || []).forEach(m => { try{ m.setStyle({ radius: Math.min(14, 6 + Math.sqrt(1)), color:'#b33', fillColor:'#ff9b9b', fillOpacity:0.95, weight:1 }); }catch(e){} });
          (item.lines || []).forEach(l => { try{ l.setStyle({ color:'#ff2e2e', weight:3, dashArray: null, opacity:1 }); }catch(e){} });
          // open popup for origin and pan next to it
          try{ item.originMarker.openPopup(); map.setView(item.originMarker.getLatLng(), 7, { animate:true }); }catch(e){}
        }

        // wire left list buttons to pan to origin region and highlight
        document.querySelectorAll('#localList .local-item').forEach(el => {
          const idx = parseInt(el.getAttribute('data-index'));
          const flyBtn = el.querySelector('.btn-fly');
          const hBtn = el.querySelector('.btn-highlight');
          if(flyBtn){ flyBtn.addEventListener('click', function(){ const lat = parseFloat(el.getAttribute('data-lat')); const lng = parseFloat(el.getAttribute('data-lng')); if(!Number.isNaN(lat)&&!Number.isNaN(lng)) map.setView([lat,lng],7,{animate:true}); }); }
          if(hBtn){ hBtn.addEventListener('click', function(){ highlightOrigin(idx); }); }
          // also allow clicking the whole item to highlight
          el.addEventListener('click', function(ev){ if(ev.target.closest('.btn-fly')||ev.target.closest('.btn-highlight')) return; highlightOrigin(idx); });
        });

        // wire target items (spread-to) to show specific target marker and highlight
        document.querySelectorAll('#localList .target-item').forEach(el => {
          const originIdx = parseInt(el.getAttribute('data-origin-index'));
          const targetIdx = parseInt(el.getAttribute('data-target-index'));
          const showBtn = el.querySelector('.btn-show-target');
          function showTarget(){
            const item = originLayers[originIdx];
            if(!item) return;
            const marker = item.targets[targetIdx];
            const line = item.lines[targetIdx];
            if(!marker) return;
            resetStyles();
            try{ marker.setStyle({ radius: Math.min(16, 6 + Math.sqrt(1)), color:'#8b0000', fillColor:'#ffb3b3', fillOpacity:1, weight:2 }); }catch(e){}
            if(line){ try{ line.setStyle({ color:'#ff2e2e', weight:3, dashArray:null, opacity:1 }); }catch(e){} }
            try{ item.originMarker.setStyle({ radius: Math.min(24, 8 + Math.sqrt(item.data.cases)), color:'#550000', fillColor:'#ff1f1f', fillOpacity:1, weight:2 }); }catch(e){}
            try{ map.setView(marker.getLatLng(), 7, { animate:true }); marker.openPopup(); }catch(e){}
          }
          if(showBtn) showBtn.addEventListener('click', showTarget);
          el.addEventListener('click', function(ev){ if(ev.target.closest('.btn-show-target')) return; showTarget(); });
        });

        // local search filter for origins and targets
        const localSearch = document.getElementById('localSearch');
        if(localSearch){
          localSearch.addEventListener('input', function(){
            const q = this.value.trim().toLowerCase();
            document.querySelectorAll('#localList [data-name]').forEach(el=>{
              const name = (el.getAttribute('data-name')||'').toLowerCase();
              if(!q || name.indexOf(q)!==-1) el.style.display=''; else el.style.display='none';
            });
          });
        }
      });
      </script>

</body>
</html>
